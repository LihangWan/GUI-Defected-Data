# 自动缺陷注入脚本说明 (auto_injector.py)

以下为各缺陷类型的实现细节、可见效果、关键约束与调试行为。脚本运行环境默认 `DEBUG_MODE = True`，会在截图时叠加红色调试框（由页面 overlay 绘制，不修改元素本身）。

## 通用机制
- 视口锁定：截图前记录 `scroll_y`，注入后恢复原滚动以保证 normal/buggy 对齐。
- 元素选择：过滤尺寸过小/过大、负坐标、幽灵元素（透明无内容），并跳过不稳定区域（类名/ID 含 carousel/slider/slick/swiper/ad/promo 等）。
- 动画冻结：每次生成前调用 `pause_animations()` 关闭全局 animation/transition，降低重排导致的偏移。
- 调试红框：截图前读取注入后 bbox（失败则用注入前），用 overlay 画红框；截图后移除。
- 差异校验：计算 normal vs buggy 的 RMS 差异，在 DEBUG_MODE 下仍保留全部样本，仅用于监控。

## 缺陷类型细节与改进分析

### 1. Layout_Overlap (布局重叠)
**当前实现：**
- 做法：给目标元素 `transform: translate(...)`，偏移 ±50px (X) 与 ±40px (Y)，并 `position: relative; z-index: 99999`。
- 可见效果：元素与周围内容重叠、位置错位。
- 约束：更新 bbox 为偏移后的坐标。

**随机性评估：** ⚠️ 偏低 - 仅4个固定值（-50/50, -40/40）
**数据质量评估：** ⭐⭐⭐ 中等 - 效果明显但模式单一

**改进建议：**
- ❌ 问题1：偏移值固定在4个组合，AI容易过拟合这些特定模式
- ❌ 问题2：未考虑元素自身尺寸，大小元素用同样偏移不合理
- ❌ 问题3：缺少斜向重叠（同时X和Y偏移）的情况
- ✅ 改进方案：
  - 偏移范围应与元素尺寸关联：`offset_x = random.randint(int(width*0.3), int(width*0.8)) * random.choice([-1, 1])`
  - 增加小幅度重叠（10-30px）用于模拟微小错位
  - 增加同时X/Y偏移的情况（概率50%）
  - 随机选择 `absolute` 或 `relative` 定位，增加样本多样性

---

### 2. Element_Missing (元素消失)
**当前实现：**
- 做法：`visibility: hidden` 隐藏目标元素。DEBUG 模式下在原位插入浅红色占位 `<div>`，无边框/无描边，避免双重红框。
- 可见效果：元素消失；调试时淡红块标示原位置。
- 约束：保留原 bbox（隐藏不变形）。

**随机性评估：** ✅ 良好 - 随机选择元素
**数据质量评估：** ⭐⭐⭐⭐ 优秀 - 效果清晰明确

**改进建议：**
- ✅ 问题1：实现较完善
- ⚠️ 问题2：仅用 `visibility: hidden`，缺少其他消失模式
- ✅ 改进方案：
  - 增加多种消失方式：`display: none`（完全移除，不占空间）、`opacity: 0`（透明但占空间）
  - 增加"部分消失"：仅隐藏子元素或文本内容
  - 对于有背景色/边框的元素，仅隐藏内容但保留边框，更贴近真实bug

---

### 3. Text_Overflow (文本溢出)
**当前实现：**
- 做法：写入超长字符串；移除 `maxlength`；设置 `white-space: nowrap; overflow: visible;`。
  - 若是 `input/textarea`：同时扩宽 `minWidth`/`width`（2x~2.5x 原宽）。
  - 非输入：直接修改 `textContent`。
- 可见效果：文字溢出或拉伸，输入框会被撑宽；调试时轻微红色背景（仅 DEBUG）。
- 约束：重取 bbox 记录放大后的尺寸。

**随机性评估：** ⚠️ 偏低 - 固定字符串模式
**数据质量评估：** ⭐⭐⭐ 中等 - 效果明显但缺少真实性

**改进建议：**
- ❌ 问题1：固定使用 "ERROR_OVERFLOW_" * 30，模式单一
- ❌ 问题2：溢出长度固定，未考虑原始文本长度比例
- ❌ 问题3：缺少多行溢出、垂直溢出场景
- ✅ 改进方案：
  - 随机生成不同类型长文本：重复单词、长URL、随机字符、多语言混合
  - 溢出倍数随机化：1.5x ~ 5x 原始长度
  - 增加垂直溢出：设置 `max-height` 然后塞入大量换行文本
  - 增加"截断错误"：文字被 `...` 省略但位置不当

---

### 4. Broken_Image (图片损坏)
**当前实现：**
- 前置：仅对 `<img>` 执行。
- 做法：替换 `src` 为无效链接；保留原宽高；设置 `display: inline-block; border: 1px solid red/gray; object-fit: contain;`。
- 可见效果：图片断裂占位或错误图标，带边框。
- 约束：bbox 不变。

**随机性评估：** ✅ 良好
**数据质量评估：** ⭐⭐⭐⭐ 优秀 - 贴近真实场景

**改进建议：**
- ✅ 问题1：实现较完善
- ⚠️ 问题2：所有断图样式统一，缺少多样性
- ✅ 改进方案：
  - 增加多种断图表现：完全空白、显示alt文本、显示破损图标、显示错误占位图
  - 随机改变尺寸：保持原尺寸 vs 压缩变形 vs 拉伸
  - 增加"背景图损坏"场景（`background-image` 404）
  - 模拟加载中状态（灰色占位+动画效果）

---

### 5. Layout_Alignment (布局对齐)
**当前实现：**
- 目的：制造对齐不齐（偏移/内边距不当）。
- 跳过：`input/textarea/select`。
- 做法：随机 24–48px 的位移，方式随机选择：
  - paddingLeft / paddingTop（40% 概率走 padding），或
  - marginLeft / marginRight / marginTop。
- 可见效果：标题/块级内容出现明显左右/上下错位。
- 约束：一般不改变自身尺寸，bbox 维持原值。

**随机性评估：** ⭐⭐ 中等
**数据质量评估：** ⭐⭐⭐ 中等 - 需要增强多样性

**改进建议：**
- ❌ 问题1：偏移范围固定（24-48px），对不同尺寸元素不够灵活
- ❌ 问题2：仅考虑单个元素错位，未模拟"整体对齐不一致"
- ❌ 问题3：未考虑文本对齐方式（text-align）的错误
- ✅ 改进方案：
  - 偏移量应基于容器或元素尺寸：5% ~ 15% 的父容器宽度
  - 增加文本对齐错误：`text-align: right` 变成 `left`，或 `center` 变成 `justify`
  - 模拟"同级元素对齐不一致"：找到兄弟元素，给部分元素加不同margin
  - 增加 `vertical-align` 错误（inline元素）

---

### 6. Layout_Spacing (布局间距)
**当前实现：**
- 目的：拉大容器子元素间距。
- 跳过：`input/textarea/select/button/img` 以及子元素 <2 的容器。
- 做法：选取约 50% 子元素，随机 marginTop/marginBottom，增量 20–45px，去除过渡动画。
- 可见效果：列表/卡片纵向间距不均匀或过大。
- 约束：容器 bbox 可能因子项外边距而微调。

**随机性评估：** ⭐⭐⭐ 良好
**数据质量评估：** ⭐⭐⭐⭐ 优秀 - 贴近真实CSS错误

**改进建议：**
- ✅ 问题1：实现较完善
- ⚠️ 问题2：仅处理垂直间距，忽略水平间距
- ⚠️ 问题3：仅增大间距，未模拟间距过小或负值
- ✅ 改进方案：
  - 增加水平间距错误：`marginLeft/Right` 不一致
  - 增加"间距过小"场景：margin设为 0 或负值导致重叠
  - 模拟 `gap`（flexbox/grid）属性错误
  - 增加"不规律间距"：第1、3、5个元素间距大，2、4小

---

### 7. Data_Format_Error (数据格式错误)
**当前实现：**
- 目标：数字输入框。
- 若当前元素不是 `input[type=number]`，在页面内另找一个可见的 number 输入。
- 做法：填入非数字值（如 `abcXYZ`, `NaN??`, `###`, `１２３abc`, `error`），并打标 `data-injected='true'`。
- 可见效果：数字框中出现非法字符串。
- 约束：记录被写入的目标框 bbox。

**随机性评估：** ⭐⭐ 中等 - 错误值从固定列表随机选
**数据质量评估：** ⭐⭐ 偏低 - 适用场景太窄

**改进建议：**
- ❌ 问题1：仅针对 `input[type=number]`，覆盖场景极少
- ❌ 问题2：错误值列表固定，缺少真实数据错误特征
- ❌ 问题3：未考虑其他数据格式：日期、邮箱、电话、URL等
- ✅ 改进方案：
  - **大幅扩展适用场景：**
    - `input[type=email]` → 填入无效邮箱（缺少@、多个@、空格等）
    - `input[type=date]` → 填入非法日期（"2023-13-45"、"abc"）
    - `input[type=tel]` → 填入字母或特殊字符
    - `input[type=url]` → 填入无效URL（无协议、空格等）
  - 数字错误应更真实：超大数、负数（不该负的场景）、小数点位数错误
  - 增加"半正确半错误"：如电话号码位数不对、邮箱@前后格式错误

---

### 8. Style_Color_Contrast (颜色对比度)
**当前实现：**
- 目的：降低文本与背景对比度。
- 做法：获取元素背景色，直接将文本色设为同色，附加 `opacity: 0.6`，移除文字阴影。
- 可见效果：文字几乎与背景融为一体，难以辨认。
- 约束：bbox 不变。

**随机性评估：** ❌ 极低 - 完全固定策略
**数据质量评估：** ⭐⭐ 偏低 - 过于极端，不够真实

**改进建议：**
- ❌ 问题1：直接用背景色作为文字色过于极端，真实场景更多是"对比度不足"而非"完全看不见"
- ❌ 问题2：未考虑背景色解析失败的情况（渐变、图片背景）
- ❌ 问题3：固定 opacity=0.6，无随机性
- ✅ 改进方案：
  - **使用对比度计算公式（WCAG标准）：**
    - 计算当前对比度，然后调整至不合格范围（1.5:1 ~ 3:1）
    - 生成"相近色"：在HSL色彩空间中，保持色相相近，仅调整亮度差为10-30
  - 增加多种低对比场景：
    - 浅灰文字+白色背景
    - 深灰文字+黑色背景
    - 彩色文字+相近色背景
  - opacity 随机化：0.3 ~ 0.7
  - 增加"背景图干扰"：在文字后添加复杂背景图案

---

### 9. Style_Size_Inconsistent (尺寸不一致)
**当前实现：**
- 目的：制造尺寸不一致。
- 做法：随机放大/缩小字体与内边距（比如字体 ×0.6~1.4，padding 左右/上下独立调整），移除过渡。
- 可见效果：同级元素出现尺寸突变，行高/对齐异常。
- 约束：可能轻微改变 bbox。

**随机性评估：** ⭐⭐⭐ 良好
**数据质量评估：** ⭐⭐⭐ 中等 - 效果明显但需增强对比

**改进建议：**
- ⚠️ 问题1：当前代码中 `scale(0.75-1.3)` 与描述不符
- ❌ 问题2：仅修改单个元素，未形成"不一致对比"
- ❌ 问题3：未考虑字体大小（font-size）的直接修改
- ✅ 改进方案：
  - **制造明确的不一致对比：**
    - 找到同级元素（siblings），修改其中1-2个，让差异可被对比
    - 例如：列表中某一项字体特别大/小
  - 增加字体属性错误：
    - `font-size` 随机化（0.5x ~ 2x）
    - `line-height` 不匹配（过大或过小）
    - `font-weight` 突变（normal → bold或相反）
  - 增加宽高比例错误：按钮宽度不一致、图片长宽比变形
  - 记录周围元素bbox，便于模型学习"对比识别"

---

## 综合改进优先级

### 🔴 高优先级（严重影响数据质量）
1. **Data_Format_Error** - 需要大幅扩展适用场景（当前过于狭窄）
2. **Style_Color_Contrast** - 需要更真实的对比度不足模拟（当前过于极端）
3. **Layout_Overlap** - 需要增加随机性和与元素尺寸关联

### 🟡 中优先级（可提升多样性）
4. **Text_Overflow** - 需要随机化文本内容和长度
5. **Layout_Alignment** - 需要增加文本对齐和多元素场景
6. **Style_Size_Inconsistent** - 需要增加同级对比场景

### 🟢 低优先级（已较完善，可增强）
7. **Layout_Spacing** - 增加水平间距和负值场景
8. **Element_Missing** - 增加多种消失模式
9. **Broken_Image** - 增加多样化断图表现

## 数据增强建议

### 训练数据质量保障
- ✅ 增加每个bug类型的严重程度分级（轻微、中等、严重）
- ✅ 记录更多上下文信息：元素标签、类名、父容器类型
- ✅ 增加"复合bug"：同一截图注入多个bug（模拟真实场景）
- ✅ 平衡各类型样本数量：当前随机选择可能导致分布不均

### 真实性增强
- ✅ 从真实bug报告中提取缺陷模式
- ✅ 考虑响应式场景：不同视口大小下的bug表现
- ✅ 增加浏览器兼容性相关的视觉bug

## 调试与稳定性策略
- Red overlay：只在截图瞬间绘制，避免元素本身添加红框；注入后重取 bbox 使红框跟随重排后的真实位置。
- 动画/过渡禁用：减少轮播/滑块/渐变导致的位移。
- 不稳定区域过滤：跳过含广告/轮播关键词的元素，降低节点被替换或滑动的概率。
- 视口锁定：注入前后滚动位置一致，利于 diff 计算与模型训练。
- 失败重试：每个 URL 最多 3 次尝试，失败则刷新页面继续下一个样本。

## 运行
- 入口：直接运行 `python auto_injector.py`。
- 配置：调整顶部的 `DEBUG_MODE`、`TARGET_URLS`、`VIEWPORT_SIZE`、输出目录等。
- 产物：
  - `dataset_injected/images/*_normal.png` 与 `*_buggy.png`
  - `dataset_injected/metadata/<id>.json`（包含 bbox 前后、归一化坐标、diff_score、scroll_y 等）

如需进一步增强特定缺陷的可视效果，可适当调大数值范围（如 Layout_Alignment 偏移或 Layout_Spacing 外边距增量），或在注入后增加等待时间。